(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{120:function(t,e,a){t.exports={overlayCanvas:"_1VTjcrIdjUewwZ-qVkXQxP",videoimage:"_27P8rrrUDhjUTuQVCNHvHs"}},254:function(t,e,a){t.exports=a(777)},259:function(t,e,a){},264:function(t,e){},266:function(t,e){},298:function(t,e){},299:function(t,e){},777:function(t,e,a){"use strict";a.r(e);var n=a(11),i=a.n(n),s=a(252),o=a.n(s),r=(a(259),a(22)),c=a(25),l=a(38),u=a(37),h=a(39),v=a(40),f=a(19),p=a(253),d=a.n(p),m=a(43),y=a.n(m),g=a(72),x=(a(770),function(t,e,a){var n=t.getContext("2d");n.fillStyle=a||"#0ff",n.fillRect(e.x,e.y,4,4)}),k=function(t){function e(t){var a;return Object(r.a)(this,e),(a=Object(l.a)(this,Object(u.a)(e).call(this,t))).canvas=null,a.pointlog=null,a.net=new v.FaceLandmark68TinyNet,a.state={faceDetect:{}},a}return Object(h.a)(e,t),Object(c.a)(e,[{key:"componentDidMount",value:function(){var t=Object(g.a)(y.a.mark(function t(){var e=this;return y.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,v.nets.tinyFaceDetector.load("models/face/");case 2:return t.next=4,v.loadFaceLandmarkModel("models/face/");case 4:console.log("load models"),setInterval(Object(g.a)(y.a.mark(function t(){return y.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.predict();case 2:case"end":return t.stop()}},t,this)})),this.props.interval);case 6:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()},{key:"predict",value:function(){var t=Object(g.a)(y.a.mark(function t(){var e,a;return y.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(this.props.canvas){t.next=2;break}return t.abrupt("return");case 2:return 128,.5,e=new v.TinyFaceDetectorOptions({inputSize:128,scoreThreshold:.5}),t.next=7,v.detectSingleFace(this.props.video,e).withFaceLandmarks();case 7:(a=t.sent)&&(this.setState({faceDetect:a}),this.props.result(a));case 9:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()},{key:"render",value:function(){return i.a.createElement("div",null)}}]),e}(n.Component),b=a(120),w=a.n(b),O={width:640,height:480},j=Math.floor(1e3/30),C=38,M=44,E=function(t){function e(t){var a;return Object(r.a)(this,e),(a=Object(l.a)(this,Object(u.a)(e).call(this,t))).media=null,a.selfRef=null,a}return Object(h.a)(e,t),Object(c.a)(e,[{key:"componentDidMount",value:function(){var t=Object(g.a)(y.a.mark(function t(){return y.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.initCam();case 2:console.log("detect init");case 3:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()},{key:"initCam",value:function(){var t=Object(g.a)(y.a.mark(function t(){var e,a=this;return y.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return this.media=navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:"environment",width:this.props.size.width}}),e=new Promise(function(t){a.media.then(function(e){a.selfRef.srcObject=e,a.selfRef.onloadedmetadata=function(e){console.log("Onload video",e),t()}}),a.media.catch(function(t){alert(t)})}),t.abrupt("return",e);case 3:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()},{key:"render",value:function(){var t=this;return i.a.createElement("video",{ref:function(e){t.selfRef=e,t.props.setSelf(e)},className:"video",autoPlay:!0,playsInline:!0,width:O.width,height:O.height})}}]),e}(n.Component),P=function(t){function e(t){var a;return Object(r.a)(this,e),(a=Object(l.a)(this,Object(u.a)(e).call(this,t))).canvas=null,a}return Object(h.a)(e,t),Object(c.a)(e,[{key:"componentDidMount",value:function(){var t=this;setInterval(function(){t.draw()},this.props.interval)}},{key:"draw",value:function(){if(this.props.video&&this.props.canvas){this.props.video.getBoundingClientRect();var t=this.canvas.getContext("2d");this.canvas.width=this.props.size.width,this.canvas.height=this.props.size.height,t.drawImage(this.props.video,0,0,this.props.size.width,this.props.size.height)}}},{key:"render",value:function(){var t=this;return i.a.createElement("canvas",{ref:function(e){t.canvas=e,t.props.set(e)},id:"canvas",className:"canvas"})}}]),e}(n.Component),F=function(t){function e(t){var a;return Object(r.a)(this,e),(a=Object(l.a)(this,Object(u.a)(e).call(this,t))).state={video:null,canvas:null},a}return Object(h.a)(e,t),Object(c.a)(e,[{key:"setVideo",value:function(t){this.state.video!==t&&t&&(this.setState({video:t}),this.props.video(t))}},{key:"setCanvas",value:function(t){this.state.canvas!==t&&t&&(this.setState({canvas:t}),this.props.canvas(t))}},{key:"render",value:function(){var t=this;return i.a.createElement("div",{className:w.a.videoimage},i.a.createElement(E,{size:this.props.size,setSelf:function(e){t.setVideo(e)}}),i.a.createElement(P,{size:this.props.size,video:this.state.video,set:function(e){t.setCanvas(e)},interval:this.props.interval}))}}]),e}(n.Component),S=function(t,e){return{x:(e.x-t.x).toFixed(2),y:(e.y-t.y).toFixed(2)}},I=function(t){return Math.sqrt(t.x*t.x+t.y*t.y)},_=function(t,e){return t.x*e.x+t.y*e.y},R=function(t,e){return t.x*e.y-e.x*t.y},A=function(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))},D=(a(776),function(t){function e(t){var a;return Object(r.a)(this,e),(a=Object(l.a)(this,Object(u.a)(e).call(this,t))).state={done:!1,progress:0,images:[]},f.map(t.assets,function(t){a.loadImage(t)}),a}return Object(h.a)(e,t),Object(c.a)(e,[{key:"loadImage",value:function(t){var e=this;f.each(t.src,function(a){var n=new Image;n.onload=function(a){var i=e.state.images;i.push({id:t.id,image:n}),e.setState({progress:e.state.progress+1,images:i}),e.props.assets.length==e.state.progress&&(e.props.setImages(e.state.images),e.setState({done:!0}))},n.src=a})}},{key:"show",value:function(){return this.state.done?i.a.createElement("div",null,this.props.children):null}},{key:"render",value:function(){return i.a.createElement(i.a.Fragment,null,this.show())}}]),e}(n.Component)),z=function(){function t(){Object(r.a)(this,t),this.isPlay=!1,this.time_total=null,this.time_start=null,this.time_interval=null,this.time_current=null,this.time_prev=null,this.delegate=[],this.init()}return Object(c.a)(t,[{key:"init",value:function(){console.log("init schedule delegate")}},{key:"update",value:function(){this.isPlay&&(this.setCurrent(),this.checkCallback(this.time_total)),window.requestAnimationFrame(this.update.bind(this))}},{key:"checkCallback",value:function(t){if(this.delegate.length){var e=f.filter(this.delegate,function(e){return e.time==Math.floor(t/1e3)});this.delegate=f.reject(this.delegate,function(e){return e.time==Math.floor(t/1e3)}),f.each(e,function(t){t.callback()})}}},{key:"start",value:function(){this.time_total=0,this.restart(),this.update()}},{key:"restart",value:function(){this.time_start=(new Date).getTime(),this.time_current=(new Date).getTime(),this.time_prev=(new Date).getTime(),this.time_interval=0,this.isPlay=!0}},{key:"pause",value:function(){this.isPlay=!1}},{key:"setCurrent",value:function(){var t=(new Date).getTime();this.time_current=t-this.time_start,this.time_interval=t-this.time_prev,this.time_total+=this.time_interval,this.time_prev=t}},{key:"setCallback",value:function(t){this.delegate.push({time:t.time,callback:t.callback})}}]),t}(),T=(Math.cos,Math.sin,Math.abs,Math.PI,Math.floor);Math.random;function B(){this.a=[],this.b=[],this.c=[],this.d=[],this.num=0}B.prototype={constructor:B,num:0,a:null,b:null,c:null,d:null,init:function(t){var e,a,n=[];this.num=t.length-1;var i=this.num,s=this.a,o=this.b,r=this.c,c=this.d;for(a=0;a<=i;a++)s[a]=t[a];for(r[0]=r[i]=0,a=1;a<i;a++)r[a]=3*(s[a-1]-2*s[a]+s[a+1]);for(n[0]=0,a=1;a<i;a++)e=4-n[a-1],r[a]=(r[a]-r[a-1])/e,n[a]=1/e;for(a=i-1;a>0;a--)r[a]=r[a]-r[a+1]*n[a];for(o[i]=c[i]=0,a=0;a<i;a++)c[a]=(r[a+1]-r[a])/3,o[a]=s[a+1]-s[a]-r[a]-c[a]},culc:function(t){var e,a=T(t),n=this.num,i=this.a,s=this.b,o=this.c,r=this.d;return a<0?a=0:a>=n&&(a=n-1),e=t-a,i[a]+(s[a]+(o[a]+r[a]*e)*e)*e}};var N=function(){function t(){Object(r.a)(this,t)}return Object(c.a)(t,[{key:"init",value:function(t){this.local={pos:{x:0,y:0},rot:0},this.img=t}},{key:"getCtx",value:function(){return this.canvas.getContext("2d")}},{key:"setCanvas",value:function(t){return this.canvas=t,this.ctx=t.getContext("2d"),this}},{key:"transform",value:function(t,e){this.move(t).rotate(e).emit()}},{key:"move",value:function(t){return this.local.pos=t,this}},{key:"rotate",value:function(t){return this.local.rot=t,this}},{key:"emit",value:function(){var t=this.getCtx();t.save();var e=this.local.rot,a=this.local.pos,n=a.x+this.img.width/2,i=a.y+this.img.height/2;return t.setTransform(Math.cos(e),Math.sin(e),-Math.sin(e),Math.cos(e),n-n*Math.cos(e)+i*Math.sin(e),i-n*Math.sin(e)-i*Math.cos(e)),t.drawImage(this.img,a.x,a.y),t.restore(),this}}]),t}(),V=function(t){function e(t,a,n){var i;return Object(r.a)(this,e),(i=Object(l.a)(this,Object(u.a)(e).call(this,a))).value=t,i.scheduler=n,i.isPlay=!0,i.frame=0,i.schedule=new z,i.init(a),i.makeFrames(),i.makeSplineFrames(),i.update(),i}return Object(h.a)(e,t),Object(c.a)(e,[{key:"update",value:function(){window.requestAnimationFrame(this.update.bind(this)),this.playAnims()}},{key:"playAnims",value:function(){this.frame>=this.value.splineFrames.length?this.frame=0:this.frame++}},{key:"makeSplineFrames",value:function(){var t=this.value.anim,e=[];t.map(function(a,n){if(t[n+1]){var i=60*(t[n+1].time-t[n].time),s=Array.apply(null,new Array(i)).map(function(e,a){var s=function(t,e,a,n){return t+(e-t)/a*n}(t[n].rot,t[n+1].rot,i,a);return{rot:Math.floor(s)}});e=e.concat(s)}});var a=[],n=[];t.map(function(t){a.push(t.pos.x),n.push(t.pos.y)});var i=new B,s=new B;i.init(a),s.init(n),this.value.splineFrames=[];var o=0;t.map(function(e,a){if(t[a+1]){var n=t[a+1].time-t[a].time;o+=60*n}a++});var r=Array.apply(null,Array(o)).map(function(e,a){var n=((t.length-1)/o*a).toFixed(2);return{index:a,pos:{x:i.culc(n),y:s.culc(n)}}});this.value.splineFrames=r.map(function(t,a){return{index:t.index,pos:t.pos,rot:e[a].rot}}),console.log("this.value.splineFrames ",this.value.splineFrames)}},{key:"makeFrames",value:function(){var t=this,e=function(t,e,a,n){return(e-t)/a*n};this.value.frames=[],f.each(this.value.anim,function(a,n){if(t.value.anim[n+1]){var i=60*(t.value.anim[n+1].time-t.value.anim[n].time),s=new Array(i),o=f.map(s,function(a,s){return{index:s,pos:{x:e(t.value.anim[n].pos.x,t.value.anim[n+1].pos.x,i,s),y:e(t.value.anim[n].pos.y,t.value.anim[n+1].pos.y,i,s)}}});t.value.frames=t.value.frames.concat(o)}else t.value.frames.push({index:1,pos:t.value.anim[n].pos})})}},{key:"transform",value:function(t,e){var a=t,n=t;this.isPlay&&(a=this.localMove(t,1),n=this.localRotate(e,1)),this.move(a).rotate(n).emit()}},{key:"localMove",value:function(t){arguments.length>1&&void 0!==arguments[1]&&arguments[1];return f.has(this.value,"frames")&&this.value.splineFrames[this.frame]?{x:t.x+this.value.splineFrames[this.frame].pos.x,y:t.y+this.value.splineFrames[this.frame].pos.y}:t}},{key:"localRotate",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return!f.has(this.value,"anim")||this.value.splineFrames[this.frame]?t:t+this.value.splineFrames[e].rot}}]),e}(N),L=(new function t(){Object(r.a)(this,t)},C),q=M,U=function(t){function e(t){var a;return Object(r.a)(this,e),(a=Object(l.a)(this,Object(u.a)(e).call(this,t))).assets=[{id:1,type:"image",src:["./images/star_01.png"],loop:!0,anim:[{index:1,pos:{x:0,y:0},rot:0,scale:{x:1,y:1},time:0},{index:2,pos:{x:-100,y:100},rot:360,scale:{x:1,y:1},time:.5},{index:3,pos:{x:-100,y:200},rot:180,scale:{x:1,y:1},time:1},{index:4,pos:{x:100,y:0},rot:200,scale:{x:1,y:1},time:1.5},{index:5,pos:{x:-100,y:-200},rot:360,scale:{x:1,y:1},time:2},{index:6,pos:{x:0,y:100},rot:180,scale:{x:1,y:1},time:2.5},{index:7,pos:{x:0,y:0},rot:0,scale:{x:1,y:1},time:3}]},{id:2,type:"ani",src:["./images/glasses_01.png"],loop:!0,anim:[{index:1,pos:{x:0,y:0},rot:0,scale:{x:1,y:1},time:0},{index:2,pos:{x:0,y:60},rot:90,scale:{x:1,y:1},time:2}]}],a.state={video:null,canvas:null,overlay:null,result:null,landmarks:null,positions:null,anies:[],selectedAssetId:1},a.overlay=null,a.schedule=new z,a.schedule.setCallback({time:5,callback:function(){console.log("callback1",5)}}),a.schedule.setCallback({time:5,callback:function(){console.log("callback2",5)}}),a}return Object(h.a)(e,t),Object(c.a)(e,[{key:"setCanvas",value:function(t){this.state.canvas!==t&&t&&this.setState({canvas:t})}},{key:"setVideo",value:function(t){this.state.video!==t&&t&&(this.setState({video:t}),console.log("setVideo "))}},{key:"setOverlay",value:function(t){this.state.overlay!==t&&t&&(this.setState({overlay:t}),this.initCanvas(),console.log("setOverlay "))}},{key:"initCanvas",value:function(){this.state.canvas&&this.state.overlay&&this.setState({width:O.width,height:O.height})}},{key:"render",value:function(){var t=this;return i.a.createElement("div",{className:"App"},i.a.createElement(F,{size:O,interval:j,video:function(e){t.setVideo(e)},canvas:function(e){t.setCanvas(e)}}),i.a.createElement(k,{canvas:this.state.canvas,video:this.state.video,interval:j,result:function(e){var a=v.getMediaDimensions(t.state.video),n=a.width,i=a.height,s=[e].map(function(t){return t.forSize(n,i)}),o=function(t){var e=t.getJawOutline();return{nose:t.getNose(),mouth:t.getMouth(),leftEye:t.getLeftEye(),rightEye:t.getRightEye(),leftEyeBrow:t.getLeftEyeBrow(),rightEyeBrow:t.getRightEyeBrow(),jawOutline:e}}(s[0].faceLandmarks);t.setState({landmarks:o,positions:s[0].landmarks.positions})}}),i.a.createElement(D,{assets:this.assets,setImages:function(e){var a=f.map(e,function(e){var a=f.filter(t.assets,function(t){return t.id==e.id});return{id:e.id,sprite:new V(a[0],e.image,t.schedule)}});t.setState({anies:a}),t.schedule.start()}},i.a.createElement(J,{video:this.state.video,landmarks:this.state.landmarks,positions:this.state.positions,showEyes:!0,showPoints:!1,setRef:function(e){t.setOverlay(e)},anies:this.state.anies,selectedAssetId:this.state.selectedAssetId})),i.a.createElement("button",{style:{display:"none"},onClick:function(){t.schedule.isPlay?t.schedule.pause():t.schedule.restart()}},"play/stop"),i.a.createElement("button",{onClick:function(){t.setState({selectedAssetId:1})}},"star"),i.a.createElement("button",{onClick:function(){t.setState({selectedAssetId:2})}},"glasses"))}}]),e}(n.Component),J=function(t){function e(t){var a;return Object(r.a)(this,e),(a=Object(l.a)(this,Object(u.a)(e).call(this,t))).canvas=null,a.tilt=null,a.star=null,a.state={points:[],tilt:null},a}return Object(h.a)(e,t),Object(c.a)(e,[{key:"componentWillReceiveProps",value:function(t){var e=this;t.landmarks&&(this.clearCanvas(),this.detectTilt(t.positions[q],t.positions[L]),this.props.showEyes&&this.drawPoints(),this.props.showPoints&&this.drawParts(),this.state.points.length&&f.each(this.state.points,function(a,n){e.initPointRate(a,n,t.positions[L],t.positions[q]),e.setPoint(a,n,t.positions[L],t.positions[q])}))}},{key:"setCanvas",value:function(t){this.canvas=t,this.props.setRef(t)}},{key:"detectTilt",value:function(t,e){var a,n=S(t,e),i=R(n,{x:100,y:0}),s=Math.acos((a=n).x/I(a)),o=s*(180/Math.PI);this.tilt=i<0?s:-o*(Math.PI/180)}},{key:"setPoint",value:function(t,e,a,n){var i=this,s={x:0,y:0},o=S(a,n),r=I(o),c=A(s,o),l=c*t.rate.dot,u=s.x+o.x/r*l+a.x,h=s.y+o.y/r*l+a.y,v=c*t.rate.cross,p=(t.bool.cross?270:90)*Math.PI/180,d={x:v*Math.cos(p)+u,y:v*Math.sin(p)+h},m=f.filter(this.props.anies,function(t){return t.id==i.props.selectedAssetId});if(m.length){var y=m[0].sprite.img,g=d.x-y.width/2,k=d.y-y.height/2;m[0].sprite.setCanvas(this.canvas).transform({x:g,y:k},this.tilt)}x(this.canvas,{x:d.x,y:d.y},"rgba(255,255,255)")}},{key:"initPointRate",value:function(t,e,a,n){if(!t.rate){var i={x:0,y:0},s=S(a,n),o=S(a,t.vector),r=R(s,o),c=Math.abs(r/A(i,s)),l=_(s,o),u=function(t,e){var a=I(t),n=I(e);return Math.cos(_(t,e)/(a*n))}(s,o),h=d.a.acos(u)*I(o),v=A(i,s),f=h/v,p=c/v,m=this.state.points;m[e].bool={dot:!(l<0),cross:r<0},m[e].rate={dot:l<0?-f:f,cross:p},this.setState({points:m})}}},{key:"clearCanvas",value:function(){this.canvas.getContext("2d").clearRect(0,0,O.width,O.height)}},{key:"drawPoints",value:function(){var t=this,e=0;f.each(this.props.positions,function(a){e==L&&x(t.canvas,{x:a.x,y:a.y},"rgba(255,0,0)"),e==q&&x(t.canvas,{x:a.x,y:a.y},"rgba(0,255,0)"),e++})}},{key:"drawParts",value:function(){var t=this,e=this.props.landmarks,a=0,n=0,i=Math.floor(25.5);f.each(e,function(e,s){a++,n=0,e.map(function(e){n++,x(t.canvas,{x:e.x,y:e.y},function(t,e){return["rgb(255,".concat(e,",").concat(e,")"),"rgb(".concat(e,",255,").concat(e,")"),"rgb(".concat(e,",").concat(e,",255)"),"rgb(255,255,".concat(e,")"),"rgb(".concat(e,",255,255)"),"rgb(255,".concat(e,",255)"),"rgb(".concat(e,",").concat(e,",").concat(e,")")][t]}(a,n*i))})})}},{key:"addPoint",value:function(t){var e=this.canvas.getBoundingClientRect(),a=t.clientX-e.left,n=t.clientY-e.top,i=this.state.points;i.push({vector:{x:a,y:n},rate:null}),this.setState({points:i}),console.log("points ",i)}},{key:"render",value:function(){var t=this;return i.a.createElement("canvas",{ref:function(e){t.setCanvas(e)},width:O.width,height:O.height,className:w.a.overlayCanvas,onClick:function(e){t.addPoint(e)}})}}]),e}(n.Component);Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));o.a.render(i.a.createElement(U,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(function(t){t.unregister()})}},[[254,2,1]]]);
//# sourceMappingURL=main.0d3f060e.chunk.js.map